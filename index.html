// ... (existing HTML and CSS) ...

<script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.js"></script>
<script>
    const API_BASE = 'https://m-m-8080-backend.vercel.app'; // Your Vercel URL
    // const API_KEY = 'MMAI-ADMIN-KEY-2293-NEW'; // This will eventually be replaced by wallet signatures for start/stop

    let walletAddress = null;
    let snipingActive = false; // This will now reflect the *actual* bot state from the backend

    const connectButton = document.getElementById('connectButton');
    const startButton = document.getElementById('startSniping');
    const stopButton = document.getElementById('stopSniping');
    const statusDiv = document.getElementById('status');
    const profitDiv = document.getElementById('profit');
    const yearlyEarningsDiv = document.getElementById('yearlyEarnings');
    const requiredSOLSpan = document.getElementById('requiredSOL');

    // ... (fetchSolPrice, updateYearlyBanner, connectWallet, getSolBalance functions - unchanged) ...

    // Start sniping bot
    async function startSniping() {
        if (!walletAddress) {
            statusDiv.textContent = 'Connect wallet first.';
            return;
        }

        startButton.disabled = true;
        stopButton.disabled = false;
        statusDiv.textContent = 'Starting sniping bot...';

        try {
            const res = await fetch(`${API_BASE}/api/start`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    // 'x-api-key': API_KEY // REMOVED: Will rely on wallet signature for real auth
                },
                body: JSON.stringify({ wallet: walletAddress }) // Pass user's wallet for backend to identify
            });
            const data = await res.json();
            if (data.success) {
                statusDiv.textContent = 'Sniping started.';
                snipingActive = true; // Set client-side state
                fetchRealProfit(); // Immediately fetch profit after start
            } else {
                statusDiv.textContent = 'Error: ' + (data.error || 'Unknown error');
                startButton.disabled = false;
                stopButton.disabled = true;
                snipingActive = false;
            }
        } catch (err) {
            console.error('Network error while starting sniping:', err);
            statusDiv.textContent = 'Network error while starting sniping.';
            startButton.disabled = false;
            stopButton.disabled = true;
            snipingActive = false;
        }
    }

    // Stop sniping bot
    async function stopSniping() {
        stopButton.disabled = true;
        startButton.disabled = false;
        statusDiv.textContent = 'Stopping sniping bot...';

        try {
            const res = await fetch(`${API_BASE}/api/stop`, {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    // 'x-api-key': API_KEY // REMOVED: Will rely on wallet signature for real auth
                },
                body: JSON.stringify({ wallet: walletAddress }) // Pass user's wallet for backend to identify
            });
            const data = await res.json();
            if (data.success) {
                statusDiv.textContent = 'Sniping stopped.';
                snipingActive = false; // Set client-side state
            } else {
                statusDiv.textContent = 'Error: ' + (data.error || 'Unknown error');
                stopButton.disabled = false; // Allow retrying stop if it failed
                startButton.disabled = false; // Re-enable start if stop failed
                snipingActive = true; // If stop failed, bot is still active
            }
        } catch (err) {
            console.error('Network error while stopping sniping:', err);
            statusDiv.textContent = 'Network error while stopping sniping.';
            stopButton.disabled = false;
            startButton.disabled = false;
            snipingActive = true;
        }
    }

    // Fetch real profit and update UI (now uses x-api-key for client access only)
    async function fetchRealProfit() {
        // Only poll if a wallet is connected, or if we *think* sniping is active
        if (!walletAddress && !snipingActive) return; 

        try {
            const res = await fetch(`${API_BASE}/api/bot-balance`, {
                headers: { 'x-api-key': 'MMAI-ADMIN-KEY-2293-NEW' } // Use the client API key here if needed
            });
            const data = await res.json();
            if (data && data.usd !== undefined && data.sol !== undefined) {
                profitDiv.textContent = `Bot Wallet Profit: $${data.usd} USD (SOL: ${data.sol})`;
            } else {
                profitDiv.textContent = 'Bot Wallet Profit: unavailable';
            }
        } catch {
            profitDiv.textContent = 'Bot Wallet Profit: unavailable';
        }
    }

    // Auto connect if trusted
    window.addEventListener('load', async () => {
        await updateYearlyBanner();

        if (window.solana && window.solana.isPhantom) {
            try {
                const resp = await window.solana.connect({ onlyIfTrusted: true });
                walletAddress = resp.publicKey.toString();
                statusDiv.textContent = `Auto-connected: ${walletAddress}`;

                const balanceSOL = await getSolBalance(walletAddress);
                const balanceUSD = balanceSOL * (await fetchSolPrice());
                if (balanceUSD >= 50) {
                    statusDiv.textContent += ` | Balance OK: $${balanceUSD.toFixed(2)}`;
                    startButton.disabled = false;
                } else {
                    statusDiv.textContent += ` | Insufficient SOL balance ($${balanceUSD.toFixed(2)}). Minimum $50 required.`;
                    startButton.disabled = true;
                }
            } catch {
                statusDiv.textContent = 'Phantom detected. Connect to begin.';
            }
        } else {
            statusDiv.textContent = 'Phantom Wallet not detected.';
        }
        // Also fetch profit on load to update initial status
        fetchRealProfit(); 
    });

    connectButton.addEventListener('click', connectWallet);
    startButton.addEventListener('click', startSniping);
    stopButton.addEventListener('click', stopSniping);

    // Poll profit every 5 seconds while a wallet is connected or sniping is thought to be active
    setInterval(fetchRealProfit, 5000);
</script>